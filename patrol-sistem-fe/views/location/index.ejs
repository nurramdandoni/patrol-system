<span style="font-size:20px;font-weight:600;">
    <%= title %>
</span>
<div style="display: flex;">
    <div style="margin-left: auto;margin-right: 8px; margin-top: 12px;">
        <%- include('../component/insert-button', {name:'Lokasi',
            linkUrl:'',linkId:'insertLocation',linkClass:'btn-insert'}) %>
    </div>
    <div style="margin-right: 8px; margin-top: 12px;">
        <%- include('../component/edit-button', {name:'Lokasi', linkUrl:'',linkId:'editLocation',linkClass:'btn-edit'})
            %>
    </div>
</div>
<div style="margin-top: 19px;">
    <div class="table-container" style="overflow: auto; max-height: 500px; padding: 5px;">
        <table style="
            width: 100%;
            border-collapse: collapse;
            font-family: Arial, sans-serif;
            border: 1px solid #d0d7de;
            border-radius: 8px;
            overflow: hidden;
            font-family: 'Poppins', sans-serif;">
            <thead>
                <tr style="background: #f0f7ff; border-bottom: 2px solid #c5d9f5;">
                    <th style="padding: 10px; text-align: left; font-weight: 600; border-right: 1px solid #e1e4e8;">#
                    </th>
                    <th style="padding: 10px; text-align: left; font-weight: 600; border-right: 1px solid #e1e4e8;">Nama
                        Lokasi</th>
                    <th style="padding: 10px; text-align: left; font-weight: 600; border-right: 1px solid #e1e4e8;">Foto
                    </th>
                    <th style="padding: 10px; text-align: left; font-weight: 600; border-right: 1px solid #e1e4e8;">
                        Status</th>
                    <th style="padding: 10px; text-align: left; font-weight: 600; border-right: 1px solid #e1e4e8;">
                        Keterangan</th>
                </tr>
            </thead>

            <tbody id="patrol-data">
                <tr style="border-bottom: 1px solid #e1e4e8; transition: 0.2s;"
                    onmouseover="this.style.background='#f9fbff'" onmouseout="this.style.background='white'">
                    <td style="padding: 10px; border-right: 1px solid #f0f0f0;">-</td>
                    <td style="padding: 10px; border-right: 1px solid #f0f0f0;">-</td>
                    <td style="padding: 10px; border-right: 1px solid #f0f0f0;">-</td>
                    <td style="padding: 10px; border-right: 1px solid #f0f0f0;">-</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div id="pagination" class="d-flex justify-content-center mt-3"></div>

    <div style="margin-top: 5px;">
        <%- include('../component/print-button', {name:'Cetak Barcode', linkUrl:'',linkId:'btnPrintPDF',linkClass:''})
            %>
            <!-- <button id="btnPrintPDF" class="btn btn-primary btn-sm">üñ®Ô∏è Cetak Barcode</button> -->
    </div>
    <div id="pdfContainer" class="mt-4 text-center">
        <!-- PDF akan ditampilkan di sini -->
    </div>
</div>

<!-- Modal Insert Update -->
<div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
            <div class="modal-body">
                <div class="text-start">
                    <form id="dataFormContent">
                        <!-- Form akan dimuat di sini dari js-->
                    </form>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-success" id="saveData">Simpan</button>
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<script>
    let modeSave = 'insert'; // insert atau edit
    function loadPatrolData(page, rowCount) {
        currentPage = page || 1;
        rowCount = rowCount || 10;
        fetch(`<%= API_URL %>/admin/location?page=${page}&rowCount=${rowCount}`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token'),
                'ngrok-skip-browser-warning': 'true'
            }
        })
            .then(async (response) => {
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server response:', errorText);
                    if (response.status === 401) {
                        alert('‚ùå ' + errorText + ' On Menu Location');
                        // Redirect ke halaman login
                        window.location.href = '/';
                    } else {
                        alert('‚ö†Ô∏è Terjadi kesalahan server (' + response.status + ')');
                    }
                    throw new Error('HTTP error ' + response.status);
                }
                let tableBody = '';
                const data = await response.json();
                data.data.forEach((item, index) => {
                    tableBody += `
          <tr style="border-bottom: 1px solid #e1e4e8; transition: 0.2s;">
            <td>
                <input type="hidden" class="location-id" value="${item.id}" />
                <input type="checkbox"/> &nbsp;${index + 1+(currentPage - 1) * rowCount}</td>
            <td>${item.name}</td>
            <td>
              ${item.images != null
                            ? item.images && item.images.trim() !== ''
                                ? `<button style="cursor:pointer;color: white;background-color: green;border-radius: 5px; border: none;" onclick="showImage('<%= API_URL %>/${item.images}')">
                        <i class="fa fa-camera"></i> onCapture
                      </button>`
                                : '<button style="color: white; background-color: red;border-radius: 5px; border: none;">notCapture</button>'
                            : '<span>-</button>'
                        }
            </td>
            <td>
              ${item.status != null
                            ? item.status == 1
                                ? '<span class="badge bg-success"><i class="bi bi-check-lg"></i> Active</span>'
                                : '<span class="badge bg-danger"><i class="bi bi-x-lg"></i> Non Active</span>'
                            : '<span class="badge bg-secondary">-</span>'
                        }
                <input type="hidden" class="qr-value" value="${item.token_location}" />
            </td>
            <td>${item.location_type.name}</td>
          </tr>
        `;
                });
                console.log(tableBody);
                document.getElementById('patrol-data').innerHTML = tableBody;
                renderPagination(data.totalData, rowCount);
            })
    }
    function renderPagination(totalData, rowCount) {
        const totalPages = Math.ceil(totalData / rowCount);
        let html = `<nav><ul class="pagination">`;

        // Prev
        html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <button class="page-link" onclick="loadPatrolData(${currentPage - 1})">
            &laquo;
        </button>
        </li>`;

        // Number
        for (let i = 1; i <= totalPages; i++) {
            if (i >= currentPage - 2 && i <= currentPage + 2) {
                html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                <button class="page-link" onclick="loadPatrolData(${i}, ${rowCount})">
                    ${i}
                </button>
                </li>`;
            }
        }

        // Next
        html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <button class="page-link" onclick="loadPatrolData(${currentPage + 1})">
            &raquo;
        </button>
        </li>`;

        html += `</ul></nav>`;
        document.getElementById('pagination').innerHTML = html;
    }

    function showImage(url) {
        if (url == "") {
            alert('Tidak ada gambar untuk dilihat.');
            return;
        }

        // Tampilkan modal terlebih dahulu
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();

        const previewImage = document.getElementById('previewImage');
        // Atur gambar sebagai loading sementara
        previewImage.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns=...'; // URL loading SVG, atau biarkan kosong

        // Lakukan FETCH untuk mendapatkan gambar sebagai BLOB
        fetch(url, {
            method: 'GET',
            headers: {
                // Masukkan header di sini!
                'ngrok-skip-browser-warning': 'true'
            }
        })
            .then(response => {
                // Jika respons bukan gambar, atau ada masalah (misalnya ngrok tetap memblokir)
                if (!response.ok) {
                    throw new Error('Gagal memuat gambar dari server: ' + response.status);
                }
                // Dapatkan data gambar sebagai Blob
                return response.blob();
            })
            .then(imageBlob => {
                // Buat URL Objek yang bisa digunakan oleh tag <img>
                const imageObjectURL = URL.createObjectURL(imageBlob);

                // Ganti src gambar dengan URL Objek Blob
                previewImage.src = imageObjectURL;
            })
            .catch(error => {
                console.error('Error memuat gambar:', error);
                alert('‚ùå Gambar gagal dimuat. Coba refresh atau klik "Visit Site" di halaman ngrok.');
                // Sembunyikan modal jika gagal
                modal.hide();
            });
    }

    document.getElementById('btnPrintPDF').addEventListener('click', async () => {
        // Ambil semua checkbox yang dicentang
        const checked = Array.from(document.querySelectorAll('#patrol-data input[type=checkbox]:checked'));

        if (checked.length === 0) {
            alert('‚ö†Ô∏è Pilih minimal satu lokasi dulu!');
            return;
        }

        // Buat array objek sesuai format { name, qr_value }
        const selectedData = checked.map(cb => {
            const row = cb.closest('tr');
            const name = row.children[1].textContent.trim(); // kolom nama lokasi
            // const qrImg = row.querySelector('img'); // ambil tag <img> di kolom QR
            // // token ada di URL src
            // const qrSrc = qrImg.getAttribute('src');
            // const qrParam = new URL(qrSrc).searchParams.get('data'); // ambil nilai data= di URL QR
            const qrParam = row.querySelector('.qr-value').value;
            return { name, qr_value: qrParam };
        });

        console.log('Data dikirim ke backend:', selectedData);

        // Kirim ke backend
        const response = await fetch('<%= API_URL %>/admin/pdf/location', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token'),
                'Content-Type': 'application/json',
                'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify({ data: selectedData })
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server response:', errorText);
            if (response.status === 401) {
                alert('‚ùå ' + errorText + ' On Print Menu Location');
                // Redirect ke halaman login
                window.location.href = '/';
            } else {
                alert('‚ö†Ô∏è Terjadi kesalahan server (' + response.status + ')');
            }
            return;
        }

        // Terima PDF sebagai blob
        const blob = await response.blob();
        const pdfUrl = URL.createObjectURL(blob);

        // Tampilkan PDF di bawah tabel
        document.getElementById('pdfContainer').innerHTML = `
    <embed src="${pdfUrl}" type="application/pdf" width="100%" height="600px" />
  `;
    });
</script>
<!-- grant access button -->
<script>
    document.addEventListener("DOMContentLoaded", () => {

        const pathNow = window.location.pathname;
        const insertCheck = JSON.parse(localStorage.getItem('menus'));

        insertCheck.forEach(menu => {
            if (pathNow === menu.menu_path) {

                // Show INSERT
                if (menu.menu_permission.includes("create")) {
                    const btn = document.getElementById("insertLocation");
                    if (btn) btn.style.display = "inline-block";
                }

                // Show EDIT
                if (menu.menu_permission.includes("edit")) {
                    const btn = document.getElementById("editLocation");
                    if (btn) btn.style.display = "inline-block";
                }

                // Show PRINT
                if (menu.menu_permission.includes("print")) {
                    const btn = document.getElementById("btnPrintPDF");
                    if (btn) btn.style.display = "inline-block";
                }
            }
        });
        document.querySelectorAll(".btn-insert").forEach(btn => {
            btn.addEventListener("click", function () {
                modeSave = 'insert';
                openModal("insert");
            });
        });
        document.querySelectorAll(".btn-edit").forEach(btn => {
            btn.addEventListener("click", function () {
                modeSave = 'edit';
                openModal("edit");
            });
        });
        loadPatrolData();
    });

    function openModal(mode) {
        // alert("Open Modal");
        const modal = new bootstrap.Modal(document.getElementById('formModal'));
        if (mode === "insert") {
            modal.show();
            document.getElementById("dataFormContent").innerHTML = `
            <h5>Tambah Lokasi Baru</h5>
            <div class="mb-3">
                <label for="locationName" class="form-label">Nama Lokasi</label>
                <input type="text" class="form-control" id="locationName" name="name" required>
            </div>
            <div class="mb-3">
                <label for="locationType" class="form-label">Tipe Lokasi</label>
                <select class="form-select" id="locationType" name="location_type_id" required>
                    <option value="">Pilih Tipe Lokasi</option>
                    <option value="1">Kawasan Non Berikat</option>
                    <option value="2">Kawasan Berikat</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="locationStatus" class="form-label">Status</label>
                <select class="form-select" id="locationStatus" name="status" required>
                    <option value="1">Active</option>
                    <option value="0">Non Active</option>
                </select>
            </div>
            `;
        } else if (mode === "edit") {
            // Ambil data dari checkbox yang dicentang
            const checked = Array.from(document.querySelectorAll('#patrol-data input[type=checkbox]:checked'));
            if (checked.length !== 1) {
                alert('‚ö†Ô∏è Pilih satu lokasi untuk diedit!');
                modal.hide();
                return;
            } else {
                modal.show();
                const row = checked[0].closest('tr');
                const locationId = row.querySelector('.location-id').value;
                $.ajax({
                    url: `<%= API_URL %>/admin/location/${locationId}`,
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                        'ngrok-skip-browser-warning': 'true'
                    },
                    success: function (data) {
                        console.log('Data lokasi diterima:', data);
                        document.getElementById("dataFormContent").innerHTML = `
                        <h5>Edit Lokasi</h5>
                        <div class="mb-3">
                            <input type="hidden" name="id" id="locationId" value="${data.id}" />
                            <label for="locationName" class="form-label">Nama Lokasi</label>
                            <input type="text" class="form-control" id="locationName" name="name" value="${data.name}" required>
                        </div>
                        <div class="mb-3">
                            <label for="locationType" class="form-label">Tipe Lokasi</label>
                            <select class="form-select" id="locationType" name="location_type_id" required>
                                <option value="">Pilih Tipe Lokasi</option>
                                <option value="1" ${data.location_type_id == '1' ? 'selected' : ''}>Kawasan Non Berikat</option>
                                <option value="2" ${data.location_type_id == '2' ? 'selected' : ''}>Kawasan Berikat</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="locationStatus" class="form-label">Status</label>
                            <select class="form-select" id="locationStatus" name="status" required>
                                <option value="1" ${data.status == '1' ? 'selected' : ''}>Active</option>
                                <option value="0" ${data.status == '0' ? 'selected' : ''}>Non Active</option>
                            </select>
                        </div>
                        `;
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching location data:', error);
                        alert('‚ùå Gagal mengambil data lokasi. Silakan coba lagi.');
                        modal.hide();
                    }
                });
            }
        }
    }
    $(document).ready(function () {
        $('#saveData').click(function () {
            const jsonData = {};
            $('#dataFormContent').serializeArray().forEach(item => {
                jsonData[item.name] = item.value;
            });
            console.log(jsonData);
            if (modeSave === 'insert') {
                // Insert mode
                $.ajax({
                    url: '<%= API_URL %>/admin/location',
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    data: JSON.stringify(jsonData),
                    success: function (data) {
                        alert('‚úÖ Lokasi berhasil ditambahkan!');
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        console.error('Error inserting location:', error);
                        alert('‚ùå Gagal menambahkan lokasi. Silakan coba lagi.');
                    }
                });
            }else if (modeSave === 'edit') {
                $.ajax({
                    url: `<%= API_URL %>/admin/location/${jsonData.id}`,
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token'),
                        'Content-Type': 'application/json',
                        'ngrok-skip-browser-warning': 'true'
                    },
                    data: JSON.stringify(jsonData),
                    success: function (data) {
                        alert('‚úÖ Lokasi berhasil diperbarui!');
                        location.reload();
                    },
                    error: function (xhr, status, error) {
                        console.error('Error updating location:', error);
                        alert('‚ùå Gagal memperbarui lokasi. Silakan coba lagi.');
                    }
                });
            }
        });
    });
</script>